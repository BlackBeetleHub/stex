#!/usr/bin/env node

// re-exec as the local version of stex if possible
var localbin = require("../lib/util/localbin");
localbin();

var gotoPackageRoot = require("../lib/util/goto-package-root");
gotoPackageRoot();

var program = require('commander');

program
  .version('0.0.1')
  .option('--watch', 'restart server if any files change');

program
  .command('www')
  .description('start a server running the app')
  .action(function(){
    if(program.watch) {
      var nodemon = require("nodemon");
      nodemon({
        exec: 'stex www',
        ext: 'js json'
      });

    } else {
      bootApp().then(function() {
        var port = conf.get('PORT')
        var server = app.listen(port, function() {
          log.debug(stex.name + ' server listening on port ' + server.address().port);
        });
      })
    }
  });

program
  .command('console')
  .description('start a repl')
  .action(function(){
    bootApp().then(function() {
      var repl   = require('repl');
      var r = repl.start("> ");
    })
  });

program
  .command('db-console')
  .description('starts a database console')
  .action(function(){
    var kexec = require("kexec");
    loadApp().then(function() {
      var db = conf.get("db");

      if(db.client !== "mysql") {
        console.log("Invalid client: " + db.client + ". only mysql supported for now");
        process.exit(1);
      }

      var program = "mysql";
      var args = [];

      if(db.connection.host) {
        args.push("-h")
        args.push(db.connection.host)
      }

      if(db.connection.user) {
        args.push("-u")
        args.push(db.connection.user)
      }

      if(db.connection.password) {
        args.push("-p")
        args.push(db.connection.password)
      }

      args.push(db.connection.database);
      kexec(program, args);
    });
  });

program
  .command('db-migrate <cmd> [arg]')
  .description('run the migration tool')
  .action(function(cmd, arg){
    var kexec   = require("kexec");
    loadApp().then(function() {
      var program = __dirname + '/../node_modules/.bin/db-migrate';
      var args    = [
        "--config",
        __dirname + "/../lib/db-migrate/config.js",
        "--env",
        conf.NODE_ENV,
        cmd,
        arg
      ]
      kexec(program, args);
    });
  });

program
  .command('humanize-logs')
  .description('processes a stream of json events into a humanized view')
  .action(function(cmd, args){
    var split     = require("split");
    var humanizer = require('../lib/util/json-log-humanizer')

    process.stdin
      .pipe(split(null, humanizer.processLine))
      .pipe(process.stdout)
  });

program.parse(process.argv);

function loadApp() {
  return require(process.cwd() + "/lib/app").then(function(stex) {
    return stex.activate();
  });
}

function bootApp() {
  return loadApp().then(function(stex) {
    return stex.boot();
  });
}