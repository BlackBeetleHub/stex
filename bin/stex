#!/usr/bin/env node

var program = require('commander');

program
  .version('0.0.1');

program
  .command('www')
  .description('start a server running the app')
  .action(function(){
    bootApp();
    var port = conf.get('PORT')
    var server = app.listen(port, function() {
      log.debug('Express server listening on port ' + server.address().port);
    });
  });

program
  .command('console')
  .description('start a repl')
  .action(function(){
    bootApp();
    var repl   = require('repl');
    var r = repl.start("> ");
  });

program
  .command('db-console')
  .description('starts a database console')
  .action(function(){
    //TODO
  });

program
  .command('db-migrate <cmd> [arg]')
  .description('run the migration tool')
  .action(function(cmd, arg){
    var kexec   = require("kexec");
    loadApp();
    var program = __dirname + '/../node_modules/.bin/db-migrate';
    var args    = [
      "--config",
      __dirname + "/../lib/db-migrate/config.js",
      "--env",
      conf.NODE_ENV,
      cmd,
      arg
    ]
    kexec(program, args);
  });

program
  .command('humanize-logs')
  .description('processes a stream of json events into a humanized view')
  .action(function(cmd, args){
    var split     = require("split");
    var humanizer = require('../lib/util/json-log-humanizer')

    process.stdin
      .pipe(split(null, humanizer.processLine))
      .pipe(process.stdout)
  });

program.parse(process.argv);

function loadApp() {
  if(stex){ return; } //only load once

  var stex = require(process.cwd() + "/lib/app");
  stex.activate();
}

function bootApp() {
  loadApp();
  stex.boot();
}